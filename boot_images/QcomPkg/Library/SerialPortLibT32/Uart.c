/*==================================================================================================

FILE: uart.c

DESCRIPTION: UEFI driver for UARTDM/UARTBAM

                    Copyright (c) 2013-2014 Qualcomm Technologies, Incorporated
                                        All Rights Reserved
                                     QUALCOMM Proprietary/GTDR

==================================================================================================*/
/*==================================================================================================


==================================================================================================*/
/*==================================================================================================
                                            DESCRIPTION
====================================================================================================

GLOBAL FUNCTIONS:
   uart_initialize
   uart_poll
   uart_read
   uart_write

==================================================================================================*/
/*==================================================================================================
                                           INCLUDE FILES
==================================================================================================*/

#include <Library/BaseLib.h>  // AsciiStrCmp()
#include <Library/IoLib.h>    // MmioWrite32(), etc.
#include "ArmDebug.h"

/*==================================================================================================
                                             CONSTANTS
==================================================================================================*/


/*==================================================================================================
                                               MACROS
==================================================================================================*/
/*==================================================================================================
                                              TYPEDEFS
==================================================================================================*/
/*==================================================================================================
                                          LOCAL VARIABLES
==================================================================================================*/

/*==================================================================================================
                                          GLOBAL FUNCTIONS
==================================================================================================*/
/*==================================================================================================

FUNCTION: uart_initialize

DESCRIPTION:

==================================================================================================*/
RETURN_STATUS EFIAPI
uart_initialize(void)
{
   return RETURN_SUCCESS;
}

/*==================================================================================================

FUNCTION: uart_poll

DESCRIPTION:

==================================================================================================*/
BOOLEAN EFIAPI
uart_poll(void)
{
  return ( (ArmDebugReadDSCR() & ARM_DEBUG_DSCR_RXFULL) != 0);
}

/*==================================================================================================

FUNCTION: uart_read

DESCRIPTION:

==================================================================================================*/
UINTN EFIAPI
uart_read(OUT UINT8 *user_buffer, IN UINTN bytes_requested)
{
  UINT8 *ptr = user_buffer;
  UINT32 i;
  for (i = 0; i < bytes_requested; i++, ptr++) {
    while ( (ArmDebugReadDSCR() & ARM_DEBUG_DSCR_RXFULL) == 0)     {
      //Wait for Rx Ready
    }
    *ptr = (UINT8) ArmDebugDTRRx();
  }
  return bytes_requested;
}

/*==================================================================================================

FUNCTION: uart_write

DESCRIPTION:

==================================================================================================*/
UINTN EFIAPI
uart_write(IN UINT8 *user_buffer, IN UINTN bytes_to_send)
{
  UINT8 *ptr = user_buffer;
  UINT32 i;
  for (i = 0; i < bytes_to_send; i++, ptr++) {
    while ( (ArmDebugReadDSCR() & ARM_DEBUG_DSCR_TXFULL) != 0)     {
      //Wait for Tx Ready
    }
    ArmDebugDTRTx (*ptr);
  }
  return (bytes_to_send);
}
